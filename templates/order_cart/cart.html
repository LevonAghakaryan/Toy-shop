{% extends 'base.html' %} 

{% block content %}
<section class="max-w-4xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-extrabold mb-8 text-gray-800 border-b pb-2">‘ª’¥ ‘∂’°’¥’¢’µ’∏÷Ç’≤’® üß∫</h1>

    <!-- ’è’•’≤’ù ’¶’°’¥’¢’µ’∏÷Ç’≤’´ items-’∂’•÷Ä’® ÷Å’∏÷Ç÷Å’°’§÷Ä’•’¨’∏÷Ç ’∞’°’¥’°÷Ä -->
    <div id="cart-items-container" class="space-y-4">
        <p id="loading-message" class="text-center text-indigo-500 font-medium">‘≤’•’º’∂’∏÷Ç’¥ ’•’¥ ’¶’°’¥’¢’µ’∏÷Ç’≤’´ ’ø’æ’µ’°’¨’∂’•÷Ä’®...</p>
    </div>

    <!-- ‘±’¥÷É’∏÷É’∏÷Ç’¥ ÷á ’ä’°’ø’æ’•÷Ä’´ ‘ø’∏’≥’°’Ø -->
    <div id="cart-summary" class="mt-10 border-t-4 border-indigo-100 pt-6 bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-3 text-gray-700">‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ‘±’¥÷É’∏÷É’∏÷Ç’¥</h2>
        <p class="text-3xl font-extrabold text-green-600 mb-8 flex justify-between items-center">
            <span>‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’£’∏÷Ç’¥’°÷Ä:</span>
            <span id="cart-total-amount">0.00</span> ÷è
        </p>

        <button id="checkout-button" onclick="submitOrder()"
                class="w-full px-8 py-4 bg-indigo-600 text-white font-bold text-lg rounded-xl shadow-indigo-400/50 shadow-md transition duration-300 hover:bg-indigo-700 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
            ‘±’æ’°÷Ä’ø’•’¨ ’ä’°’ø’æ’•÷Ä’® (Checkout) üõí
        </button>
    </div>
</section>
{% endblock %}

{% block extra_js %}
    <!-- ‘ø’°÷Ä÷á’∏÷Ä ’ß’ù ÷Ö’£’ø’°’£’∏÷Ä’Æ’∏÷Ç’¥ ’•’∂÷Ñ ’∂’∏÷Ç’µ’∂ cart_manager.js ÷Ü’°’µ’¨’® -->
    <script src="{{ url_for('static', path='js/cart_manager.js') }}"></script>

    <script>
        // ’ñ’∏÷Ç’∂’Ø÷Å’´’°’∂, ’∏÷Ä’® ’Ø’¢’•’º’∂’´ ÷á ’Ø÷Å’∏÷Ç÷Å’°’§÷Ä’´ ’¶’°’¥’¢’µ’∏÷Ç’≤’® Backend-’´÷Å
        async function loadCartAndRender() {
            const cartItemsContainer = document.getElementById('cart-items-container');
            const totalAmountElement = document.getElementById('cart-total-amount');
            const checkoutButton = document.getElementById('checkout-button');
            const loadingMessage = document.getElementById('loading-message');

            // 1. ’Ñ’°÷Ñ÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’¢’•’º’∂’¥’°’∂ ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®
            cartItemsContainer.innerHTML = '';

            try {
                // 2. ‘ø’°’∂’π’∏÷Ç’¥ ’•’∂÷Ñ ’°’Ω’´’∂÷Ñ÷Ä’∏’∂ ÷Ü’∏÷Ç’∂’Ø÷Å’´’°’∂ Backend-’´÷Å ’ø’æ’µ’°’¨’∂’•÷Ä ’¢’•÷Ä’•’¨’∏÷Ç ’∞’°’¥’°÷Ä
                const cartData = await fetchCart();

                totalAmountElement.textContent = cartData.total_amount.toFixed(2);

                if (cartData.items.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-xl text-gray-500 font-medium text-center py-10">’Å’•÷Ä ’¶’°’¥’¢’µ’∏÷Ç’≤’® ’§’°’ø’°÷Ä’Ø ’ß÷â ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’°’æ’•’¨’°÷Å’∂’•’¨ ’°’∫÷Ä’°’∂÷Ñ’∂’•÷Ä÷â</p>';
                    checkoutButton.disabled = true;
                } else {
                    checkoutButton.disabled = false;

                    cartData.items.forEach(item => {
                        // item.product-’® ’∫’°÷Ä’∏÷Ç’∂’°’Ø’∏÷Ç’¥ ’ß ’°’∫÷Ä’°’∂÷Ñ’´ ’ø’æ’µ’°’¨’∂’•÷Ä’® (’°’∂’∏÷Ç’∂, ’£’´’∂), item.subtotal-’® ’•’Ø’•’¨ ’ß Backend-’´÷Å
                        const subtotal = item.subtotal;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center border p-4 rounded-xl bg-white shadow-sm hover:shadow-md transition duration-200';
                        itemDiv.innerHTML = `
                            <!-- ‘±’∫÷Ä’°’∂÷Ñ’´ ‘±’∂’∏÷Ç’∂ ÷á ‘≥’´’∂ -->
                            <div class="flex-grow">
                                <span class="font-semibold text-lg text-gray-800">${item.product.name}</span>
                                <p class="text-sm text-gray-500">${item.product.price} ÷è / ’∞’°’ø</p>
                            </div>

                            <!-- ’î’°’∂’°’Ø -->
                            <div class="flex items-center mx-4 space-x-2">
                                <span class="text-gray-600">${item.quantity} ’∞’°’ø</span>
                            </div>

                            <!-- ‘µ’∂’©’°’£’∏÷Ç’¥’°÷Ä -->
                            <span class="font-extrabold text-xl w-1/4 text-right text-indigo-700">${subtotal.toFixed(2)} ÷è</span>
                        `;
                        cartItemsContainer.appendChild(itemDiv);
                    });
                }
            } catch (error) {
                cartItemsContainer.innerHTML = '<p class="text-xl text-red-500 text-center py-10">‚ùå ’è’æ’µ’°’¨’∂’•÷Ä’´ ’¢’•’º’∂’¥’°’∂ ’Ω’≠’°’¨÷â</p>';
                checkoutButton.disabled = true;
                console.error("Failed to render cart:", error);
            }
        }

        // ‘∑’ª’´ ’¢’•’º’∂’∏÷Ç’¥’®
        document.addEventListener('DOMContentLoaded', loadCartAndRender);
    </script>
{% endblock %}